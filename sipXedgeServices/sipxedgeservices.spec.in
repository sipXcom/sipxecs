Name: @PACKAGE@
Version: @VERSION@
Release: @PACKAGE_REVISION@

Summary: SIP Bridging Solutions for sipXecs
License: AGPL
Vendor: Ezuce Inc.
Url: http://www.ezuce.com


BuildRequires: automake
BuildRequires: gcc-c++
BuildRequires: cppunit-devel
BuildRequires: zip

%if 0%{?fedora} >= 18
BuildRequires: libdb4-cxx-devel
BuildRequires: libdb4-devel
Requires: libdb4-cxx
Requires: libdb4
%endif

%if 0%{?fedora_version} < 18 || 0%{?rhel} >= 6
BuildRequires: db4-cxx-devel
BuildRequires: db4-devel
Requires: db4-cxx
Requires: db4
%endif


BuildRequires: sipxcommserverlib-devel  >= %version
BuildRequires: sipxportlib-devel        >= %version
BuildRequires: sipxtacklib-devel        >= %version
BuildRequires: sipxresiprocate-devel    >= %version
BuildRequires: sipxesllib-devel >= %version
BuildRequires: libjsonrpccpp-devel

Requires: sipxesllib
Requires: sipxcommserverlib  >= %version
Requires: sipxportlib        >= %version
Requires: sipxtacklib       >= %version
Requires: sipxresiprocate-libs    >= %version
Requires: sipxesllib >= %version
Requires: libjsonrpccpp
Requires: freeswitch_edge
Requires: sipxedgeservices-config
Requires: monit




Source:   %name-%version.tar.gz

%description
SIP Bridging Solutions for sipXecs

%package utils
Summary: Utility Applications for sipX Edge Services

%description utils
Utility Applications for sipX Edge Services

%package rpc
Summary: RPC Server for sipX Edge Services

%description rpc
RPC Server for sipX Edge Services

%package config
Summary: Configuration files for sipX Edge Services

%description config
Configuration files for sipX Edge Services

%prep
%setup -q

%build
%configure @SIPX_RPM_CONFIGURE_OPTIONS@
cp config.log %name.configlog
make %{_smp_mflags}

%install
make DESTDIR=%{buildroot} install
rm -rf %{buildroot}/include/esl
rm -rf %{buildroot}/usr/opt/sipxpbx/edge/include
#
# Install configuration templates
#
mkdir -p %{buildroot}/etc/sipxpbx/edge
cp -rpP applications/config %{buildroot}/%{_sysconfdir}/sipxpbx/edge/.config

%post config

SIPXEDGE_FS_SIP_TRACE="no"
SIPXEDGE_FS_CONTEXT="WebRtcBridge"
SIPXEDGE_ESL_PORT=11000
SIPXEDGE_FS_ESL_PORT=11002
SIPXEDGE_FS_SIP_PORT=35080
SIPXEDGE_FS_INT_SIP_PORT=35082
SIPXEDGE_FS_CODEC="PCMU,PCMA"
SIPXEDGE_FS_INT_CONTEXT="sipxedge_internal"
SIPXEDGE_FS_INT_CODEC="PCMU,PCMA"

SIPXEDGE_MONIT_HTTPPORT=38000
SIPXEDGE_MONIT_PASSWORD="sipxedge"

SIPXEDGE_WS_PORT=5064
SIPXEDGE_WS_TCP_UDP_PORT=5065
SIPXEDGE_BRIDGE_TCP_UDP_PORT=5066


if [ -d %{_sysconfdir}/sipxpbx/edge/config ]; then
    echo "Configuration already installed in %{_sysconfdir}/sipxpbx/edge/config"
else
    echo "Performing post config operation"
    cp -rpP %{_sysconfdir}/sipxpbx/edge/.config %{_sysconfdir}/sipxpbx/edge/config
    cd %{_sysconfdir}/sipxpbx/edge/config


    #
    # Determine the system host ip
    #
    SIPXEDGE_HOST_IP=`ifconfig | grep -Eo 'inet (addr:)?([0-9]*\.){3}[0-9]*' | grep -Eo '([0-9]*\.){3}[0-9]*' | grep -v '127.0.0.1' | head -n 1`

    #
    # Configure freeswitch.xml
    #
    sed -i "s:%SIPXEDGE_ESL_PORT%:${SIPXEDGE_ESL_PORT}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_ESL_PORT%:${SIPXEDGE_FS_ESL_PORT}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_SIP_TRACE%:${SIPXEDGE_FS_SIP_TRACE}:g" ./freeswitch.xml

    #
    # Public Profile
    #
    sed -i "s:%SIPXEDGE_HOST_IP%:${SIPXEDGE_HOST_IP}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_SIP_PORT%:${SIPXEDGE_FS_SIP_PORT}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_CODEC%:${SIPXEDGE_FS_CODEC}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_CONTEXT%:${SIPXEDGE_FS_CONTEXT}:g" ./freeswitch.xml

    #
    # Internal Profile
    #
    sed -i "s:%SIPXEDGE_HOST_IP%:${SIPXEDGE_HOST_IP}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_INT_SIP_PORT%:${SIPXEDGE_FS_INT_SIP_PORT}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_INT_CODEC%:${SIPXEDGE_FS_INT_CODEC}:g" ./freeswitch.xml
    sed -i "s:%SIPXEDGE_FS_INT_CONTEXT%:${SIPXEDGE_FS_INT_CONTEXT}:g" ./freeswitch.xml

    #
    # Configure monitrc
    #
    sed -i "s:%SIPXEDGE_MONIT_HTTPPORT%:${SIPXEDGE_MONIT_HTTPPORT}:g" ./monitrc
    sed -i "s:%SIPXEDGE_MONIT_PASSWORD%:${SIPXEDGE_MONIT_PASSWORD}:g" ./monitrc

    #
    # Configure sipxwebrtcd
    #
    sed -i "s:%SIPXEDGE_HOST_IP%:${SIPXEDGE_HOST_IP}:g" ./sipxwebrtcd
    sed -i "s:%SIPXEDGE_ESL_PORT%:${SIPXEDGE_ESL_PORT}:g" ./sipxwebrtcd
    sed -i "s:%SIPXEDGE_FS_ESL_PORT%:${SIPXEDGE_FS_ESL_PORT}:g" ./sipxwebrtcd
    sed -i "s:%SIPXEDGE_WS_PORT%:${SIPXEDGE_WS_PORT}:g" ./sipxwebrtcd
    sed -i "s:%SIPXEDGE_WS_TCP_UDP_PORT%:${SIPXEDGE_WS_TCP_UDP_PORT}:g" ./sipxwebrtcd
    sed -i "s:%SIPXEDGE_BRIDGE_TCP_UDP_PORT%:${SIPXEDGE_BRIDGE_TCP_UDP_PORT}:g" ./sipxwebrtcd

    #
    # Set file permissions
    #
    chmod 0700 ./monitrc
    chmod +x ./pid_from_path.pl

    #
    # Create a data directory
    #
    mkdir -p /var/log/sipxpbx/edge

    #
    # Move the init script
    #
    mv ./sipxedge /etc/init.d
    chmod +x /etc/init.d/sipxedge

    #
    # Move the daemon scripts
    #
    mv ./sipxwebrtcd /usr/bin
    chmod +x /usr/bin/sipxwebrtcd
    mv ./freeswitch_edged /usr/bin
    chmod +x /usr/bin/freeswitch_edged

    #
    # Move the setup-script
    #
    mv ./sipxedge-setup /usr/bin
    chmod +x /usr/bin/sipxedge-setup

    #
    # Create monit softlink
    #
    mkdir -p  /opt/sipxecs/edge/monit/bin
    cd /opt/sipxecs/edge/monit/bin
    ln -snf /usr/bin/monit ./monit

fi

%clean
rm -rf $RPM_BUILD_ROOT

%files
%defattr(644,root,root,755)
%attr(755,root,root) %{_bindir}/sipxwebrtc

%files utils
%defattr(644,root,root,755)
%attr(755,root,root) %{_bindir}/sipxcallgen_fs

%files rpc
%defattr(644,root,root,755)
%attr(755,root,root) %{_bindir}/sipxedgerpc

%files config
%dir %attr(0750,-,-) %{_sysconfdir}/sipxpbx/edge/.config
%{_sysconfdir}/sipxpbx/edge/.config/*

