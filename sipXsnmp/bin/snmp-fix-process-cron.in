#!/bin/env python
import netsnmp
import os
import os.path
import sys

if not os.path.isfile('@SIPX_CFDATA@/snmp_fix_dead_processes'):
    sys.exit(0)

# http://www.oidview.com/mibs/2021/UCD-SNMP-MIB.html
proc_oid = '.1.3.6.1.4.1.2021.2.1' # ucdavis.prTable.prEntry
proc_status = netsnmp.Varbind(proc_oid, '100') # prErrFlag
proc_fix = netsnmp.Varbind(proc_oid, '103') # prErrFixCmd
proc_vars = netsnmp.VarList(proc_status, proc_fix)
procs = netsnmp.snmpwalk(proc_vars, DestHost = 'localhost', Version = 2, Community = 'public')
# proc_table format : 
#   0|1, cmd1, 0|1, cmd2, ...
# where
#    0 = ok, 1 = dead
#    cmd1 = if dead, command to run to start process back up
for i in range(len(procs) / 2):
    if procs[2 * i] == '1':
        cmd = procs[(2 * i ) + 1].split()
        print "Starting failed process ", cmd[1]
        os.spawnlp(os.P_WAIT, cmd[0], *cmd)
